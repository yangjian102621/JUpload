!function(e){if(!window.applicationCache)throw new Error("您当前的浏览器不支持HTML5,请先升级浏览器才能使用该上传插件!");e.fn.imageCrop=function(i,a){e(this).on("load",function(){var t,n,s,o,l=this.width/this.height,d=i/a;l>=d?(n=a,t=i*l,o=0,s=(t-i)/2):(t=i,n=a/l,s=0,o=0),e(this).css({position:"absolute",top:-o+"px",left:-s+"px",width:t+"px",height:n+"px"})})},e.fn.draggable=function(i){var a={handler:null};i=e.extend(a,i);var t=this;e(i.handler).mousedown(function(i){var a=i.pageX-e(t).position().left,n=i.pageY-e(t).position().top;e(document).mousemove(function(i){window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),e(t).css({top:i.pageY-n+"px",left:i.pageX-a+"px"})})}).mouseup(function(){e(document).unbind("mousemove")})},void 0==Array.prototype.remove&&(Array.prototype.remove=function(e){for(var i=0;i<this.length;i++)if(this[i]==e){this.splice(i,1);break}}),void 0==Array.prototype.uinque&&(Array.prototype.uinque=function(){for(var e,i=[],a={},t=0;null!=(e=this[t]);t++)a[e]||(i.push(e),a[e]=!0);return i}),window.BUpload=function(a){function t(){var t=new i;t.append('<div class="uedbody"><div class="ued_title">'),t.append('<div class="uedbar"><span>多图上传</span></div><div class="close_btn icon" title="关闭对话框"></div>'),t.append('</div><div class="wrapper"><div id="wra_head" class="wra_head"><span class="tab tab-upload focus" tab="upload-panel">本地上传</span>'),null!=a.list_url&&t.append('<span class="tab tab-online" tab="online">文件服务器</span>'),null!=a.search_url&&t.append('<span class="tab tab-search" tab="searchbox">图片搜索</span>'),t.append('</div><div class="wra_body"><div class="tab-panel upload-panel"><div class="wra_pla"><div class="upload-image-placeholder">'),t.append('<div class="btn btn-primary image-select">点击选择图片</div><input type="file" name="'+a.src+'" class="webuploader-element-invisible" multiple="multiple" accept="'+m()+'">'),t.append('</div></div><div class="image-list-box" style="display: none;"><div class="wra_bar"><div class="info fl"></div>'),t.append('<div class="fr"><span class="btn btn-default btn-continue-add">继续添加</span><span class="btn btn-primary btn-start-upload">开始上传</span></div></div>'),t.append('<ul class="filelist"></ul></div></div><div class="tab-panel online"><div class="imagelist"><ul class="list clearfix"></ul><div class="no-data"></div></div></div>'),t.append('<div class="tab-panel searchbox"><div class="search-bar"><input class="searTxt" type="text" placeholder="请输入搜索关键词" />'),t.append('<input value="搜索一下" class="btn btn-primary btn-search" type="button" /><input value="清空搜索" class="btn btn-default btn-reset" type="button" />'),t.append('</div><div class="search-imagelist-box"><ul class="search-list"></ul><div class="no-data"></div></div>'),t.append('</div><div class="loading-icon"></div></div><!-- end of wrapper --></div><div class="wra-btn-group"><span class="btn btn-primary btn-confirm">确认</span>'),t.append('<span class="btn btn-default btn-cancel">取消</span></div></div>'),_.dialog=e(t.toString()),e("body").append(_.dialog),_.dialog.css({left:(e(window).width()-_.dialog.width())/2+"px",top:"40px"}),_.dialog.draggable({handler:_.dialog.find(".ued_title")})}function n(){g(".tab").on("click",function(){var i=e(this).attr("tab");g(".tab-panel").hide(),g("."+i).show(),g(".tab").removeClass("focus"),e(this).addClass("focus")}),g(".close_btn").on("click",function(){_.close()}),g(".webuploader-element-invisible").on("change",function(){s(this)}),g(".image-select").on("click",function(){g(".webuploader-element-invisible").trigger("click")}),g(".btn-continue-add").on("click",function(){g(".webuploader-element-invisible").trigger("click")}),g(".btn-start-upload").on("click",function(){if(!_.uploadLock){if(0==_.todoList.length)return alert("请至少添加一个文件！"),!1;e(this).addClass("disabled").text("正在上传"),o(_.todoList.shift())}}),g(".btn-confirm").on("click",function(){return _.todoList.length>0?(alert("您还有文件没有上传!"),!1):(a.callback(_.selectedList),void _.close())}),g(".btn-cancel").on("click",function(){_.close()}),g(".tab-online").on("click",function(){0==g(".imagelist .list").children().length&&v()}),g(".imagelist").on("scroll",function(){this.scrollTop+this.clientHeight>=this.scrollHeight&&v()}),g(".search-imagelist-box").on("scroll",function(){this.scrollTop+this.clientHeight>=this.scrollHeight&&h()}),g(".btn-search").on("click",function(){var e=g(".searTxt").val().trim();return""==e?(g(".searchbox .no-data").html('<span class="error">请输入搜索关键字.</span>').show(),g(".searTxt").focus(),!1):(_.searchText=e,_.searchPage=1,g(".search-imagelist-box").find(".search-list").empty(),void h())}),g(".btn-reset").on("click",function(){g(".searTxt").val("")})}function s(t){for(var n=t.files,s=_.todoList.length+_.uploadSuccessNum+n.length,o=_.addedFileNumber;o<_.addedFileNumber+n.length;o++){if(s>a.max_filenum)return void alert("您本次最多上传"+a.max_filenum+"个文件.");var l=new i,d=n[o-_.addedFileNumber];l.append('<li id="img-comtainer-'+o+'"><div class="imgWrap">');var c=u(d.name);""==c&&(c="default"),c=c.toLowerCase(),-1=="jpg|jpeg|gif|png|bmp".indexOf(c)?l.append('<span class="icon-placeholder icon-'+c+'"></span>'):l.append('<img src="'+window.URL.createObjectURL(d)+'" border="0" />'),l.append('</div><div class="file-opt-box clearfix"><span class="remove" index="'+o+'">删除</span><span class="rotateRight">向右旋转</span>'),l.append('<span class="rotateLeft">向左旋转</span></div><div class="success"></div><div class="error"></div>'),l.append('<div class="progress"><span style="display: none; width: 0px;"></span></div></li>');var r=e(l.toString());r.find(".remove").on("click",function(){e(this).parents("li").remove();for(var i=e(this).attr("index"),a=0;a<_.todoList.length;a++)if(_.todoList[a].index==i){p(_.uploadSuccessNum+_.todoList.length,_.totalFilesize-_.todoList[a].file.size),_.todoList.splice(a,1);break}}),r.on("mouseover",function(){e(this).find(".file-opt-box").show()}).on("mouseout",function(){e(this).find(".file-opt-box").hide()}),g(".wra_pla").hide(),g(".image-list-box").show(),g(".filelist").append(r),_.todoList.push({index:o,file:d}),_.totalFilesize+=d.size}_.addedFileNumber+=n.length,p(_.uploadSuccessNum+_.todoList.length,_.totalFilesize),e(".imgWrap img").imageCrop(113,113)}function o(i){if(!r(i))return void l();var t=new XMLHttpRequest;t.open("POST",a.upload_url),t.addEventListener("load",function(t){if("json"==a.data_type){var n=e.parseJSON(t.target.responseText);0==n.code?(_.selectedList.push(n.message),_.uploadSuccessNum++,e("#img-comtainer-"+i.index).find(".file-opt-box").remove(),e("#img-comtainer-"+i.index).find(".progress").remove(),e("#img-comtainer-"+i.index).find(".success").show()):f(b[n.code],i)}},!1),t.addEventListener("loadend",function(){l()},!1),t.addEventListener("error",function(){f("发生异常，上传失败!",i)},!1),t.upload.addEventListener("progress",function(e){d(e,i)},!1);var n=new FormData;n.append(a.src,i.file),t.send(n)}function l(){if(_.todoList.length){var e=_.todoList.shift();o(e)}else _.uploadLock=!1,g(".btn-start-upload").removeClass("disabled").text("开始上传")}function d(i,a){i.lengthComputable&&e("#img-comtainer-"+a.index).find(".progress span").css({width:i.loaded/i.total*100+"%",display:"block"})}function p(e,i){g(".info").text("共选择了 "+e+" 张图片，共 "+c(i)+", 还可以添加 "+(a.max_filenum-e)+" 张图片.")}function c(e){return e/1048576>1?(e/1048576).toFixed(2)+"MB":(e/1024).toFixed(2)+"KB"}function r(e){var i=1024*a.max_filesize;if(i>0&&e.file.size>i)return f("文件大小不能超过 "+a.max_filesize+" KB",e),!1;var t=u(e.file.name);return t&&-1!=a.ext_allow.indexOf(t)&&-1==a.ext_refuse.indexOf(t)?!0:(f("非法的文件后缀 "+t,e),!1)}function u(e){var i=e.lastIndexOf(".");return-1!=i?e.substr(i+1).toLowerCase():!1}function m(){var i=a.ext_allow.split("|"),t=[];return e.each(i,function(e,i){t.push(w[i])}),t.length>1?t.uinque().join(","):"*"}function f(e,i){g("#img-comtainer-"+i.index).find(".error").show().text(e)}function g(e){return _.dialog.find(e)}function v(){return null==a.list_url?(g(".online .no-data").html('<span class="error">无法获取图片，请先配置 list_url.</span>').show(),!1):_.noRecord?!1:(g(".loading-icon").show(),void e.get(a.list_url,{page:_.page},function(e){g(".loading-icon").hide(),"0"==e.code?(_.page++,x(e.data,"online")):(g(".online .no-data").text(a.no_data_text).show(),_.noRecord=!0)},"json"))}function h(){return null==a.search_url?(g(".searchbox .no-data").html('<span class="error">无法进行图片搜索，请先配置 search_url.</span>').show(),!1):(g(".loading-icon").show(),void e.get(a.search_url,{page:_.searchPage,kw:_.searchText},function(e){g(".loading-icon").hide(),"0"==e.code?(g(".searchbox .no-data").hide(),_.searchPage++,x(e.data,"search")):g(".no-data").text(a.no_data_text).show()},"json"))}function x(a,t){e.each(a,function(a,n){var s=new i;s.append("<li>");var o=u(n.thumbURL);""==o&&(o="default"),o=o.toLowerCase(),-1=="jpg|jpeg|gif|png|bmp".indexOf(o)?s.append('<span class="icon-placeholder icon-'+o+'" data-src="'+n.oriURL+'"></span>'):s.append('<img src="'+n.thumbURL+'" data-src="'+n.oriURL+'" border="0">'),s.append('<span class="ic"><em class="img-size">'+n.width+"x"+n.height+"</em></span></li>");var l=e(s.toString());l.find(".ic").on("click",function(){var i=e(this).prev().attr("data-src");e(this).hasClass("selected")?(e(this).removeClass("selected"),_.selectedList.remove(i)):(e(this).addClass("selected"),_.selectedList.push(i))}),l.find("img").imageCrop(113,113),"online"==t?g(".imagelist .list").append(l):"search"==t&&g(".search-imagelist-box .search-list").append(l)})}a=e.extend({src:"src",upload_url:null,list_url:null,search_url:null,data_type:"json",max_filesize:2048,max_filenum:20,no_data_text:"(⊙o⊙)亲，没有多数据了。",ext_allow:"jpg|png|gif|jpeg",ext_refuse:"exe|txt",callback:function(e){console.log(e)}},a);var b={0:"文件上传成功",1:"文件上传失败",2:"文件大小超出限制",3:"非法文件名后缀"},w={"3gpp":"audio/3gpp, video/3gpp",ac3:"audio/ac3",asf:"allpication/vnd.ms-asf",au:"audio/basic",css:"text/css",csv:"text/csv",doc:"application/msword",dot:"application/msword",dtd:"application/xml-dtd",dwg:"image/vnd.dwg",dxf:"image/vnd.dxf",gif:"image/gif",htm:"text/html",html:"text/html",jp2:"image/jp2",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript, application/javascript",json:"application/json",mp2:"audio/mpeg, video/mpeg",mp3:"audio/mpeg",mp4:"audio/mp4, video/mp4",mpeg:"video/mpeg",mpg:"video/mpeg",mpp:"application/vnd.ms-project",ogg:"application/ogg, audio/ogg",pdf:"application/pdf",png:"image/png",pot:"application/vnd.ms-powerpoint",pps:"application/vnd.ms-powerpoint",ppt:"application/vnd.ms-powerpoint",rtf:"application/rtf, text/rtf",svf:"image/vnd.svf",tif:"image/tiff",tiff:"image/tiff",txt:"text/plain",wdb:"application/vnd.ms-works",wps:"application/vnd.ms-works",xhtml:"application/xhtml+xml",xlc:"application/vnd.ms-excel",xlm:"application/vnd.ms-excel",xls:"application/vnd.ms-excel",xlt:"application/vnd.ms-excel",xlw:"application/vnd.ms-excel",xml:"text/xml, application/xml",zip:"aplication/zip",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"},_={};return _.dialog=null,_.todoList=new Array,_.uploadSuccessNum=0,_.selectedList=new Array,_.addedFileNumber=0,_.totalFilesize=0,_.uploadLock=!1,_.page=1,_.searchPage=1,_.searchText=null,_.noRecord=!1,_.close=function(){_.dialog.remove()},t(),n(),_};var i=function(){var e=new Array;i.prototype.append=function(i){e.push(i)},i.prototype.toString=function(){return e.join("")}}}(jQuery);