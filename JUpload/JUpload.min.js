!function(e){var t=!0;window.applicationCache||(t=!1),void 0==Array.prototype.remove&&(Array.prototype.remove=function(e){for(var t=0;t<this.length;t++)if(this[t]==e){this.splice(t,1);break}}),e.fn.imageCrop||(e.fn.imageCrop=function(t,n){e(this).on("load",function(){var i,a,o,r,s=this.width/this.height,c=t/n;s>=c?(a=n,i=t*s,r=0,o=(i-t)/2):(i=t,a=n/s,o=0,r=0),e(this).css({position:"absolute",top:-r+"px",left:-o+"px",width:i+"px",height:a+"px"})})});var n=document.scripts,i=n[n.length-1],a=i.src,o=a.substring(0,a.lastIndexOf("/")+1)+"css/jupload.css";e("head:eq(0)").append('<link href="'+o+'" rel="stylesheet" type="text/css" />'),e.fn.JUpload=function(n){function i(t){var n=new r;n.append('<div class="img-wrapper"><div class="img-container" style="width: '+l.twidth+"px; height: "+l.theight+'px">'),n.append('<img src="'+t+'">'),n.append('<div class="file-opt-box clearfix"><span class="remove">删除</span></div></div></div>');var i=e(n.toString());e("#"+l.image_container).append(i),i.find("img").imageCrop(l.twidth,l.theight),i.find(".remove").on("click",function(){try{var t=e(this).parent().prev().attr("src");p.remove(t),i.remove(),l.onRemove(p),u--}catch(n){console.log(n)}}),p.push(t)}function a(t){if(o(t)){var n=new XMLHttpRequest;n.open("POST",l.url),n.addEventListener("load",function(t){var n=e.parseJSON(t.target.responseText);"000"==n.code?(null!=l.image_container&&i(n.item),u++,l.onSuccess(n.item)):(c("上传失败"),l.onError())},!1),n.addEventListener("loadend",function(){l.onComplete()},!1),n.addEventListener("error",function(e){},!1),n.upload.addEventListener("progress",function(e){},!1),n.upload.addEventListener("loadstart",function(e){},!1);var a=new FormData;a.append(l.src,t),n.send(a)}}function o(e){var t=1024*l.maxFileSize*1024;if(t>0&&e.size>t)return c("文件大小不能超过 "+l.maxFileSize+"MB"),l.onError(),!1;var n=s(e.name);return n&&-1!=l.extAllow.indexOf(n)&&-1==l.extRefuse.indexOf(n)?!0:(c("非法的文件后缀 "+n),l.onError(),!1)}function s(e){var t=e.lastIndexOf(".");return-1!=t?e.substr(t+1).toLowerCase():!1}function c(e){l.messageHandler(e)}var l=e.extend({src:"src",url:null,maxFileSize:2,onStart:function(){},onComplete:function(){},onSuccess:function(e){},onError:function(){},onRemove:function(e){},messageHandler:function(e){alert(e)},image_container:null,maxFileNum:5,extAllow:"jpg|png|gif|jpeg",extRefuse:"exe|txt",datas:[],twidth:113,theight:113},n),p=[],u=0;if(l.datas.length>0){for(var d=0;d<l.datas.length;d++)i(l.datas[d]);p=l.datas,u=p.length}var m="iframe_"+Math.random(),f=e('<form action="'+l.url+'" target="'+m+'" enctype="multipart/form-data" method="post"></form>'),h=e('<input type="file" name="'+l.src+'" class="upload-input" />'),v=e('<iframe name="'+m+'" class="upload-iframe"></iframe>');e(this).on("click",function(){h.trigger("click")}),t?h.on("change",function(){return l.maxFileNum>0&&u>=l.maxFileNum?(c("您最多允许上传"+l.maxFileNum+"张图片。"),!1):(l.onStart(),void setTimeout(function(){a(h[0].files[0])},200))}):(h.on("change",function(){return""==h.val()?(c("请选择文件."),!1):l.maxFileNum>0&&u>=l.maxFileNum?(c("您最多允许上传"+l.maxFileNum+"张图片。"),!1):(l.onStart(),void setTimeout(function(){f[0].submit()},200))}),v.on("load",function(){try{var t=this.contentWindow.document.getElementsByTagName("pre")[0].innerHTML;if(!t)return!1;var n=e.parseJSON(t);"000"==n.code?(null!=l.image_container&&i(n.item),u++,l.onSuccess(n.item),h.val("")):alert(n.message),l.onComplete()}catch(a){}})),f.append(h),e("body").append(f),e("body").append(v),l.image_container&&e("#"+l.image_container).addClass("clearfix")};var r=function(){var e=new Array;r.prototype.append=function(t){e.push(t)},r.prototype.toString=function(){return e.join("")}}}(jQuery);