!function(e){var t=!1;"undefined"!=typeof Worker&&(t=!0),void 0==Array.prototype.remove&&(Array.prototype.remove=function(e){for(var t=0;t<this.length;t++)if(this[t]==e){this.splice(t,1);break}}),e.fn.imageCrop||(e.fn.imageCrop=function(t,n){e(this).on("load",function(){var a,i,r,o,s=this.width/this.height,c=t/n;s>=c?(i=n,a=t*s,o=0,r=(a-t)/2):(a=t,i=n/s,r=0,o=0),e(this).css({position:"absolute",top:-o+"px",left:-r+"px",width:a+"px",height:i+"px"})})});var n=document.scripts,a=n[n.length-1],i=a.src,r=i.substring(0,i.lastIndexOf("/")+1)+"jupload.min.css";e("head:eq(0)").append('<link href="'+r+'" rel="stylesheet" type="text/css" />'),e.fn.JUpload=function(n){function a(t){var n=new o;n.append('<div class="img-wrapper"><div class="img-container" style="width: '+d.twidth+"px; height: "+d.theight+'px">'),n.append('<img src="'+t+'" data-src="'+t+'">'),n.append('<div class="file-opt-box clearfix"><span class="remove">删除</span></div></div></div>');var a=e(n.toString());e("#"+d.image_container).append(a),a.find("img").imageCrop(d.twidth,d.theight),a.find(".remove").on("click",function(){try{var t=e(this).parent().prev().attr("src");u.remove(t),a.remove(),d.onRemove(u),l--}catch(n){console.log(n)}}),u.push(t)}function i(t){if(r(t)){var n=new XMLHttpRequest;n.open("POST",d.url),n.addEventListener("load",function(t){var n=e.parseJSON(t.target.responseText);"000"==n.code?(null!=d.image_container&&a(n.data.url),l++,d.onSuccess(n.data)):(c("上传失败"),d.onError())},!1),n.addEventListener("loadend",function(){d.onComplete()},!1),n.addEventListener("error",function(e){},!1),n.upload.addEventListener("progress",function(e){},!1),n.upload.addEventListener("loadstart",function(e){},!1);var i=new FormData;i.append(d.src,t),n.send(i)}}function r(e){var t=1024*d.maxFileSize*1024;if(t>0&&e.size>t)return c("文件大小不能超过 "+d.maxFileSize+"MB"),d.onError(),!1;var n=s(e.name);return n&&-1!=d.extAllow.indexOf(n)&&-1==d.extRefuse.indexOf(n)?!0:(c("非法的文件后缀 "+n),d.onError(),!1)}function s(e){var t=e.lastIndexOf(".");return-1!=t?e.substr(t+1).toLowerCase():!1}function c(e){d.messageHandler(e)}var d=e.extend({src:"src",url:null,maxFileSize:2,onStart:function(){},onComplete:function(){},onSuccess:function(e){},onError:function(){},onRemove:function(e){},messageHandler:function(e){alert(e)},image_container:null,maxFileNum:5,extAllow:"jpg|png|gif|jpeg",extRefuse:"exe|txt",datas:[],twidth:113,theight:113},n),u=[],l=0;if(d.datas.length>0){for(var p=0;p<d.datas.length;p++)a(d.datas[p]);u=d.datas,l=u.length}var f="iframe_"+Math.random(),m=e('<form action="'+d.url+'" target="'+f+'" enctype="multipart/form-data" method="post"></form>'),v=e('<input type="file" name="'+d.src+'" class="upload-input" />'),g=e('<iframe name="'+f+'" class="upload-iframe"></iframe>');e(this).on("click",function(){v.trigger("click")}),t?v.on("change",function(){return d.maxFileNum>0&&l>=d.maxFileNum?(c("您最多允许上传"+d.maxFileNum+"张图片。"),!1):(d.onStart(),void setTimeout(function(){i(v[0].files[0])},200))}):(v.on("change",function(){return""==v.val()?(c("请选择文件."),!1):d.maxFileNum>0&&l>=d.maxFileNum?(c("您最多允许上传"+d.maxFileNum+"张图片。"),!1):(d.onStart(),void setTimeout(function(){m[0].submit()},200))}),g.on("load",function(){try{var t=this.contentWindow.document.getElementsByTagName("pre")[0].innerHTML;if(!t)return!1;var n=e.parseJSON(t);"000"==n.code?(null!=d.image_container&&a(n.data.url),l++,d.onSuccess(n.data),v.val("")):c(n.message),d.onComplete()}catch(i){}})),m.append(v),e("body").append(m),e("body").append(g),d.image_container&&e("#"+d.image_container).addClass("clearfix")};var o=function(){var e=new Array;o.prototype.append=function(t){e.push(t)},o.prototype.toString=function(){return e.join("")}}}(jQuery);