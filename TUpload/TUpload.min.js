!function(e){window.TUpload=function(n){function t(){var t='<div class="tupload-container">		<div class="tupload-panel">         <div class="image-list-box">         </div>     </div>     <div class="tupload-btn-box">         <button class="btn-upload"></button>         <button class="btn-add-file"></button>     </div>     <span class="tupload-close"></span></div>';x=e(t),x.draggable(),e("body").append(x);var d=e('<div class="init-add-file-btn"></div>'),s=e('<input type="file" class="input-select-file" multiple="true">'),l=e('<div class="addmore-box"><span class="addmore-btn"></span></div>');l.on("click",function(){u(".input-select-file").trigger("click")}),u(".btn-add-file").on("click",function(){return v.length>0?(alert("请先上传文件！"),!1):(h.length>0&&n.callback(h),void p())}),u(".tupload-close").on("click",function(){p()}),u(".btn-upload").on("click",function(){return 0==v.length?(alert("请至少添加一个文件！"),!1):void a(v.shift())}),s.on("change",function(){0==u(".image-list-box").find(".addmore-box").length?u(".image-list-box").append(l):l.show();for(var t=s[0].files,a=u(".img-container").length,d=a;d<a+t.length;d++){if(v.length>=n.maxFileNum){alert("您本次最多上传"+n.maxFileNum+"个文件.");break}var r=e('<div class="img-container" id="img-comtainer-'+b+d+'">    <div class="image">       <img src="'+window.URL.createObjectURL(t[d-a])+'" border="0">       <div class="mask">等待上传……</div>     </div>     <div class="file-info">         <div class="tupload-progress"><span class="tupload-progress-bar" id="upload-progress-bar-'+b+d+'"></span></div>         <div class="file-size">'+o(t[d-a].size)+'</div>     </div>     <span class="remove" index="'+d+'"></span>     <span class="success"></span></div>');r.find(".remove").on("click",function(){i(this)}),r.find("img").imageCrop(150,150),u(".addmore-box").before(r),v.push(t[d-a])}u(".init-add-file-btn").hide()}),d.append(s),u(".tupload-panel").append(d),d.css({top:(u(".tupload-panel").height()-d.height())/2+"px",left:(u(".tupload-panel").width()-d.width())/2+"px"});var r=window.document.body.scrollTop||window.document.documentElement.scrollTop;x.css({top:r+n.top+"px",zIndex:n.zIndex,left:(e(window).width()-x.width())/2})}function i(n){e(n).parent().remove();var t=e(n).attr("index");v.splice(t,1),0==u(".img-container").length&&(u(".init-add-file-btn").show(),u(".addmore-box").hide()),u(".image-list-box").find(".remove").each(function(n,t){e(t).attr("index",n)})}function o(e){return e/1048576>1?(e/1048576).toFixed(2)+"MB":(e/1024).toFixed(2)+"KB"}function a(t){if(!d(t))return g++,void r();var i=new XMLHttpRequest;i.open("POST",n.uploadUrl),i.addEventListener("load",function(t){if("json"==n.dataType){var i=e.parseJSON(t.target.responseText);"000"==i.code?(h.push(i.item),e("#img-comtainer-"+b+g).find(".remove").hide().next().show(),e("#img-comtainer-"+b+g).find(".mask").hide()):e("#img-comtainer-"+b+g).find(".mask").html(m[i.code]).addClass("error")}n.onSuccess(i.item)},!1),i.addEventListener("loadend",function(){g++,r()},!1),i.addEventListener("error",function(e){n.onError(e)},!1),i.upload.addEventListener("progress",function(e){c(e)},!1),i.upload.addEventListener("loadstart",function(e){n.onLoadStart(e)},!1);var o=new FormData;o.append(n.src,t),i.send(o)}function d(e){var t=1024*n.maxFileSize;if(t>0&&e.size>t)return l("文件大小不能超过 "+n.maxFileSize+" KB"),!1;var i=s(e.name);return i&&-1!=n.extAllow.indexOf(i)&&-1==n.extRefuse.indexOf(i)?!0:(l("非法的文件后缀 "+i),!1)}function s(e){var n=e.lastIndexOf(".");return-1!=n?e.substr(n+1).toLowerCase():!1}function l(e){u("#img-comtainer-"+b+g).find(".mask").html(e).addClass("error")}function r(){if(v.length){var e=v.shift();a(e)}else n.onComplete(),g=0,v=new Array}function c(e){e.lengthComputable&&u("#upload-progress-bar-"+b+g).css({width:e.loaded/e.total*100+"%"})}function u(e){return x.find(e)}function p(){x.remove();try{JDialog.lock.hide()}catch(e){}}if(!window.applicationCache)return void alert("您当前的浏览器不支持HTML5,请先升级浏览器才能使用该上传插件!");e.fn.imageCrop=function(n,t){e(this).on("load",function(){var i,o,a,d,s=this.width/this.height,l=n/t;s>=l?(o=t,i=n*s,d=0,a=(i-n)/2):(i=n,o=t/s,a=0,d=0),e(this).css({position:"absolute",top:-d+"px",left:-a+"px",width:i+"px",height:o+"px"})})},e.fn.draggable=function(n){var t={handler:null};n=e.extend(t,n);var i=this,o=n.handler;o||(o=this),e(o).mousedown(function(n){var t=n.pageX-e(i).position().left,o=n.pageY-e(i).position().top;e(document).mousemove(function(n){window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),e(i).css({top:n.pageY-o+"px",left:n.pageX-t+"px"})})}).mouseup(function(){e(document).unbind("mousemove")})};var f={src:"src",uploadUrl:null,dataType:"json",maxFileSize:2048,maxFileNum:20,extAllow:"jpg|png|gif|jpeg",extRefuse:"exe|txt",zIndex:9999,top:50,callback:function(e){},onSuccess:function(e){},onError:function(e){},onLoadStart:function(e){},onComplete:function(){u(".addmore-box").hide()}},m={"000":"文件上传成功","001":"文件上传失败","002":"文件大小超出限制","003":"非法文件名后缀"};n=e.extend(f,n);var v=new Array,g=0,h=new Array,x=null,b=Math.ceil(1e12*Math.random());t()}}(jQuery);